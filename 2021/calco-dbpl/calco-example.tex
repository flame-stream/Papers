TODO SQL cross query optimization